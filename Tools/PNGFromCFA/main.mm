#import <Cocoa/Cocoa.h>
#import <sys/stat.h>
#import <vector>
#import <string>
#import <filesystem>
#import <iostream>
#import <unordered_map>
#import "Mmap.h"
#import "Renderer.h"
#import "ImagePipelineTypes.h"
#import "DebayerLMMSE.h"
#import "Mat.h"
#import "Color.h"
using namespace CFAViewer;
namespace fs = std::filesystem;

struct CCM {
    double cct = 0;
    Mat<double,3,3> m; // CamRaw -> ProPhotoRGB
};

// Indoor, night
const CCM CCM1 = {
    .cct = 2700, // Guess for indoor lighting
    .m = {
        0.598457560014931,  0.113346231148492,  0.288196208836577,
        -0.365021496190295, 1.35991855224469,   0.00510294394560497,
        -0.179792379530340, -0.791837884750571, 1.97163026428091
    },
};

// Outdoor, 4pm
const CCM CCM2 = {
    .cct = 5503, // D55 (afternoon daylight)
    .m = {
        0.836464733695617,      -0.174223734662964, 0.337759000967347,
        -0.0275561801749826,    0.796387462849104,  0.231168717325879,
        -0.0285393434063563,    -0.622494750933791, 1.65103409434015
    },
};

static Mat<double,3,3> CCMInterp(const CCM& lo, const CCM& hi, double cct) {
    const double k = ((1/cct) - (1/lo.cct)) / ((1/hi.cct) - (1/lo.cct));
    return lo.m*(1-k) + hi.m*k;
}

// Approximate CCT given xy chromaticity, using the Hernandez-Andres equation
static double CCTFromXYChromaticity(double x, double y) {
    const double xe[]   = { 0.3366,      0.3356     };
    const double ye[]   = { 0.1735,      0.1691     };
    const double A0[]   = { -949.86315,  36284.48953};
    const double A1[]   = { 6253.80338,  0.00228    };
    const double t1[]   = { 0.92159,     0.07861    };
    const double A2[]   = { 28.70599,    5.4535e-36 };
    const double t2[]   = { 0.20039,     0.01543    };
    const double A3[]   = { 0.00004,     0          };
    const double t3[]   = { 0.07125,     0.07125    };
    const double n[]    = {(x-xe[0])/(y-ye[0]), (x-xe[1])/(y-ye[1])};
    const double cct[]  = {
        A0[0] + A1[0]*exp(-n[0]/t1[0]) + A2[0]*exp(-n[0]/t2[0]) + A3[0]*exp(-n[0]/t3[0]),
        A0[1] + A1[1]*exp(-n[1]/t1[1]) + A2[1]*exp(-n[1]/t2[1]) + A3[1]*exp(-n[1]/t3[1]),
    };
    
    if (cct[0] <= 50000) return cct[0];
    else                 return cct[1];
}

static CCM CCMForIlluminant(const Color<ColorSpace::Raw>& illumRaw) {
    // Start out with a guess for the xy coordinates (D55 chromaticity)
    double x = 0.332424;
    double y = 0.347426;
    CCM ccm;
    
    // Iteratively estimate the xy chromaticity of `illumRaw`,
    // along with the CCT and interpolated CCM.
    constexpr int MaxIter = 50;
    for (int i=0; i<MaxIter; i++) {
        // Calculate CCT from current xy chromaticity estimate, and interpolate between
        // CCM1 and CCM2 based on that CCT
        CCM ccm2;
        ccm2.cct = std::clamp(CCTFromXYChromaticity(x,y), CCM1.cct, CCM2.cct);
        ccm2.m = CCMInterp(CCM1, CCM2, ccm2.cct);
        
        // Convert `illumRaw` to ProPhotoRGB coordinates using ccm2 (the new interpolated CCM)
        const Color<ColorSpace::ProPhotoRGB> illumRGB(ccm2.m * illumRaw.m);
        // Convert illumRGB to XYZ coordinates
        const Color<ColorSpace::XYZ<ColorSpace::ProPhotoRGB::White>> illumXYZ(illumRGB);
        
        constexpr double Eps = .01;
        const double x2 = illumXYZ[0]/(illumXYZ[0]+illumXYZ[1]+illumXYZ[2]);
        const double y2 = illumXYZ[1]/(illumXYZ[0]+illumXYZ[1]+illumXYZ[2]);
        const double Δx = std::abs((x-x2)/x);
        const double Δy = std::abs((y-y2)/y);
        const double Δcct = std::abs((ccm.cct-ccm2.cct)/ccm.cct);
        double Δccm = 0;
        for (int y=0; y<3; y++) {
            for (int x=0; x<3; x++) {
                Δccm = std::max(Δccm, std::abs((ccm.m.at(y,x)-ccm2.m.at(y,x))/ccm.m.at(y,x)));
            }
        }
        
        ccm = ccm2;
        x = x2;
        y = y2;
        
        if (Δx<Eps && Δy<Eps && Δcct<Eps && Δccm<Eps) return ccm;
    }
    
    throw std::runtime_error("didn't converge");
}

static simd::float3x3 SIMDFromMat(const Mat<double,3,3>& m) {
    return {
        simd::float3{(float)m.at(0,0), (float)m.at(1,0), (float)m.at(2,0)},
        simd::float3{(float)m.at(0,1), (float)m.at(1,1), (float)m.at(2,1)},
        simd::float3{(float)m.at(0,2), (float)m.at(1,2), (float)m.at(2,2)},
    };
}

static CGColorSpaceRef SRGBColorSpace() {
    static CGColorSpaceRef cs = CGColorSpaceCreateWithName(kCGColorSpaceSRGB);
    return cs;
}

static void writePNG(id<MTLTexture> txt, const fs::path& path) {
    const size_t ComponentsPerPixel = 4; // RGBA
    const size_t BytesPerComponent = 2; // 16-bit floats
    const size_t w = [txt width];
    const size_t h = [txt height];
    const size_t bytesPerRow = ComponentsPerPixel*BytesPerComponent*w;
    const uint32_t opts = kCGImageAlphaNoneSkipLast|kCGBitmapFloatComponents|kCGBitmapByteOrder16Little;
    id ctx = CFBridgingRelease(CGBitmapContextCreate(nullptr, w, h, BytesPerComponent*8, bytesPerRow,
        SRGBColorSpace(), opts));
    
    if (!ctx) throw std::runtime_error("CGBitmapContextCreate returned nil");
    
    uint8_t* data = (uint8_t*)CGBitmapContextGetData((CGContextRef)ctx);
    [txt getBytes:data bytesPerRow:bytesPerRow fromRegion:MTLRegionMake2D(0,0,w,h) mipmapLevel:0];
    
    id img = CFBridgingRelease(CGBitmapContextCreateImage((CGContextRef)ctx));
    if (!img) throw std::runtime_error("CGBitmapContextCreateImage returned nil");
    
    id imgDest = CFBridgingRelease(CGImageDestinationCreateWithURL(
        (CFURLRef)[NSURL fileURLWithPath:@(path.c_str())], kUTTypePNG, 1, nullptr));
    if (!imgDest) throw std::runtime_error("CGImageDestinationCreateWithURL returned nil");
    CGImageDestinationAddImage((CGImageDestinationRef)imgDest, (CGImageRef)img, nullptr);
    CGImageDestinationFinalize((CGImageDestinationRef)imgDest);
}

static void createPNGFromCFA(Renderer& renderer, uint32_t width, uint32_t height, const fs::path& path) {
    using namespace ImagePipeline;
    const CFADesc CFADesc = {CFAColor::Green, CFAColor::Red, CFAColor::Blue, CFAColor::Green};
    
    const std::unordered_map<std::string,Color<ColorSpace::Raw>> C50Illuminants = {
        { "indoor_night_3", { 0.5795003771781921, 0.6879686117172241, 0.4368963837623596 } },
        { "indoor_night_4", { 0.5972203612327576, 0.6915167570114136, 0.4063650071620941 } },
        { "indoor_night_5", { 0.5663390755653381, 0.684330940246582, 0.45929428935050964 } },
        { "indoor_night_6", { 0.5887182354927063, 0.6842938661575317, 0.4302937090396881 } },
        { "indoor_night_7", { 0.6178863048553467, 0.6910690069198608, 0.37502041459083557 } },
        { "indoor_night_8", { 0.6299829483032227, 0.6890959143638611, 0.35814565420150757 } },
        { "indoor_night_15", { 0.6039132475852966, 0.6952248811721802, 0.3898089528083801 } },
        { "indoor_night_16", { 0.5794650912284851, 0.6910439729690552, 0.43206292390823364 } },
        { "indoor_night_17", { 0.5857053995132446, 0.6920403838157654, 0.42193517088890076 } },
        { "indoor_night_18", { 0.6160566806793213, 0.696533203125, 0.3678528964519501 } },
        { "indoor_night_19", { 0.5944971442222595, 0.6951201558113098, 0.40420427918434143 } },
        { "indoor_night_20", { 0.5899587869644165, 0.6932166218757629, 0.4140041172504425 } },
        { "indoor_night_24", { 0.5959473252296448, 0.6914991140365601, 0.40825948119163513 } },
        { "indoor_night_25", { 0.5572435259819031, 0.684425413608551, 0.47015050053596497 } },
        { "indoor_night_26", { 0.5933972597122192, 0.6901329755783081, 0.41424161195755005 } },
        { "indoor_night_27", { 0.605392575263977, 0.6926782727241516, 0.3920415937900543 } },
        { "indoor_night_28", { 0.5811170339584351, 0.6893721222877502, 0.4325149655342102 } },
        { "indoor_night_34", { 0.6100133061408997, 0.6938492655754089, 0.38269710540771484 } },
        { "indoor_night_35", { 0.6120595932006836, 0.6945705413818359, 0.3780936896800995 } },
        { "indoor_night_36", { 0.6123981475830078, 0.6949886679649353, 0.37677475810050964 } },
        { "indoor_night_37", { 0.5965551733970642, 0.6921632289886475, 0.4062413275241852 } },
        { "indoor_night_38", { 0.6163582801818848, 0.6922383904457092, 0.3753777742385864 } },
        { "indoor_night_39", { 0.5984464883804321, 0.6908863186836243, 0.4056326150894165 } },
        { "indoor_night_40", { 0.5962528586387634, 0.6918572783470154, 0.407205194234848 } },
        { "indoor_night_41", { 0.6020115613937378, 0.692658543586731, 0.39724835753440857 } },
        { "indoor_night_42", { 0.6287199258804321, 0.6935343146324158, 0.35174062848091125 } },
        { "indoor_night_43", { 0.6214606165885925, 0.6935554146766663, 0.36437293887138367 } },
        { "indoor_night_44", { 0.6090744137763977, 0.6943008899688721, 0.3833726942539215 } },
        { "indoor_night_45", { 0.6098664999008179, 0.6938223838806152, 0.38297951221466064 } },
        { "indoor_night_46", { 0.6064794063568115, 0.6928184628486633, 0.3901093602180481 } },
        { "indoor_night_47", { 0.6164490580558777, 0.69247967004776, 0.37478306889533997 } },
        { "indoor_night_48", { 0.627449095249176, 0.6933879852294922, 0.35428887605667114 } },
        { "indoor_night_49", { 0.6160481572151184, 0.694367527961731, 0.37193870544433594 } },
        { "indoor_night_50", { 0.6143658757209778, 0.693792462348938, 0.3757745325565338 } },
        { "indoor_night_51", { 0.6206439137458801, 0.6945557594299316, 0.36385923624038696 } },
        { "indoor_night_54", { 0.6390467286109924, 0.6967414617538452, 0.32583823800086975 } },
        { "indoor_night_55", { 0.6483958959579468, 0.6957058310508728, 0.3091539144515991 } },
        { "indoor_night_56", { 0.6344584226608276, 0.6971694827079773, 0.3337920606136322 } },
        { "indoor_night_57", { 0.6380857229232788, 0.6969760060310364, 0.3272172510623932 } },
        { "indoor_night_60", { 0.6387431621551514, 0.6972768902778625, 0.3252875804901123 } },
        { "indoor_night_61", { 0.6472063064575195, 0.6961818337440491, 0.3105718195438385 } },
        { "indoor_night_62", { 0.6493707895278931, 0.6962085962295532, 0.30595964193344116 } },
        { "indoor_night_63", { 0.642465353012085, 0.6965039968490601, 0.3195629417896271 } },
        { "indoor_night_64", { 0.6453055739402771, 0.6964672207832336, 0.31386956572532654 } },
        { "indoor_night_65", { 0.6377063989639282, 0.6965458393096924, 0.3288683593273163 } },
        { "indoor_night_66", { 0.6359556913375854, 0.6965862512588501, 0.3321564495563507 } },
        { "indoor_night_67", { 0.6447587609291077, 0.6964196562767029, 0.3150966465473175 } },
        { "indoor_night_68", { 0.643968403339386, 0.6961856484413147, 0.31722259521484375 } },
        { "indoor_night_69", { 0.6433002948760986, 0.6964339017868042, 0.31803223490715027 } },
        { "indoor_night_72", { 0.6158788800239563, 0.6966571807861328, 0.3679157495498657 } },
        { "indoor_night_74", { 0.640837550163269, 0.6958373785018921, 0.32424917817115784 } },
        { "indoor_night_75", { 0.6473914384841919, 0.6952395439147949, 0.3122919797897339 } },
        { "indoor_night_76", { 0.6514182090759277, 0.6961396932601929, 0.30173465609550476 } },
        { "indoor_night_77", { 0.6407203078269958, 0.6960335969924927, 0.3240596055984497 } },
        { "indoor_night_78", { 0.6432358026504517, 0.6960490942001343, 0.31900355219841003 } },
        { "indoor_night_79", { 0.6407999992370605, 0.6966825127601624, 0.3225037157535553 } },
        { "indoor_night_80", { 0.6480264663696289, 0.6961790323257446, 0.3088631331920624 } },
        { "indoor_night_81", { 0.6426880955696106, 0.6956351399421692, 0.321004182100296 } },
        { "indoor_night_82", { 0.6436706781387329, 0.6963499188423157, 0.3174664080142975 } },
        { "indoor_night_83", { 0.6392090916633606, 0.69621741771698, 0.32663896679878235 } },
        { "indoor_night_84", { 0.6457475423812866, 0.6963100433349609, 0.3133089542388916 } },
        { "indoor_night_85", { 0.6460551619529724, 0.6962669491767883, 0.31276994943618774 } },
        { "indoor_night_86", { 0.6359742879867554, 0.6962940096855164, 0.3327330946922302 } },
        { "indoor_night_87", { 0.6348351240158081, 0.6971318125724792, 0.33315402269363403 } },
        { "indoor_night_88", { 0.634131908416748, 0.6966886520385742, 0.3354126214981079 } },
        { "indoor_night_89", { 0.6275097727775574, 0.6968148350715637, 0.34739112854003906 } },
        { "indoor_night_99", { 0.6134340763092041, 0.6947847604751587, 0.3754633963108063 } },
        { "indoor_night_100", { 0.63225257396698, 0.6961384415626526, 0.3400704562664032 } },
        { "indoor_night_103", { 0.5923344492912292, 0.6944190859794617, 0.40856096148490906 } },
        { "indoor_night_104", { 0.6206676959991455, 0.6960977911949158, 0.3608594536781311 } },
        { "indoor_night_105", { 0.6146461963653564, 0.6960139870643616, 0.3711800277233124 } },
        { "indoor_night_106", { 0.6230001449584961, 0.6954478621482849, 0.35808268189430237 } },
        { "indoor_night_107", { 0.6267440915107727, 0.696952223777771, 0.34849604964256287 } },
        { "indoor_night_108", { 0.6244227886199951, 0.697522759437561, 0.3515085279941559 } },
        { "indoor_night_109", { 0.6191954612731934, 0.6974210143089294, 0.3608335554599762 } },
        { "indoor_night_110", { 0.6254338622093201, 0.6969587206840515, 0.35082897543907166 } },
        { "indoor_night_111", { 0.6264364123344421, 0.6963103413581848, 0.3503274917602539 } },
        { "indoor_night_117", { 0.6184234023094177, 0.6943934559822083, 0.36792704463005066 } },
        { "indoor_night_121", { 0.5394977331161499, 0.6793264150619507, 0.4974512457847595 } },
        { "indoor_night_122", { 0.5341846942901611, 0.6769206523895264, 0.5063844919204712 } },
        { "indoor_night_123", { 0.5680434107780457, 0.6896465420722961, 0.44912609457969666 } },
        { "indoor_night_124", { 0.5541006326675415, 0.6834911704063416, 0.4751970171928406 } },
        { "indoor_night_125", { 0.5766603350639343, 0.6864370703697205, 0.44302040338516235 } },
        { "indoor_night_128", { 0.5799719095230103, 0.6920753717422485, 0.42972591519355774 } },
        { "indoor_night_133", { 0.560222327709198, 0.6829017400741577, 0.46882426738739014 } },
        { "indoor_night_136", { 0.5663142204284668, 0.6865172982215881, 0.4560506045818329 } },
        { "indoor_night_139", { 0.5549147129058838, 0.6843714714050293, 0.4729749858379364 } },
        { "indoor_night_148", { 0.6103894114494324, 0.6970839500427246, 0.3761630058288574 } },
        { "indoor_night_150", { 0.6069457530975342, 0.6979685425758362, 0.3800746500492096 } },
        { "indoor_night_151", { 0.6049023270606995, 0.698294997215271, 0.3827236294746399 } },
        { "indoor_night_157", { 0.6184946298599243, 0.6922311186790466, 0.3718610405921936 } },
        { "indoor_night_158", { 0.6431633830070496, 0.6890860795974731, 0.33391809463500977 } },
        { "indoor_night_159", { 0.6165656447410583, 0.693983793258667, 0.3717974126338959 } },
        { "indoor_night_160", { 0.6312641501426697, 0.6922630667686462, 0.3496818244457245 } },
        { "indoor_night_161", { 0.6186642050743103, 0.6928260922431946, 0.37046802043914795 } },
        { "indoor_night_162", { 0.6163689494132996, 0.6931889057159424, 0.373602032661438 } },
        { "indoor_night_163", { 0.6181203126907349, 0.6919925212860107, 0.3729257583618164 } },
        { "indoor_night_166", { 0.626430332660675, 0.6918877959251404, 0.35899341106414795 } },
        { "indoor_night_168", { 0.61717289686203, 0.6937783360481262, 0.3711727559566498 } },
        { "indoor_night_169", { 0.6172664165496826, 0.6937334537506104, 0.37110114097595215 } },
        { "indoor_night_170", { 0.5891247987747192, 0.6928370594978333, 0.41582298278808594 } },
        { "indoor_night_171", { 0.614317774772644, 0.6952890753746033, 0.3730774521827698 } },
        { "indoor_night_172", { 0.6275289058685303, 0.6951271295547485, 0.3507217764854431 } },
        { "indoor_night_173", { 0.6114258766174316, 0.69533771276474, 0.3777087926864624 } },
        { "indoor_night_174", { 0.5865175127983093, 0.6923311352729797, 0.4203270375728607 } },
        { "indoor_night_175", { 0.5932902097702026, 0.6941815614700317, 0.4075765609741211 } },
        { "indoor_night_176", { 0.6104365587234497, 0.6942200064659119, 0.38134753704071045 } },
        { "outdoor_4pm_2", { 0.45919522643089294, 0.6635195016860962, 0.5906620621681213 } },
        { "outdoor_4pm_3", { 0.4628685414791107, 0.6700257062911987, 0.5803604125976562 } },
        { "outdoor_4pm_4", { 0.4613565504550934, 0.6647025942802429, 0.5876399278640747 } },
        { "outdoor_4pm_5", { 0.4671666920185089, 0.6677702069282532, 0.5795155763626099 } },
        { "outdoor_4pm_6", { 0.4722531735897064, 0.6704888939857483, 0.5722076296806335 } },
        { "outdoor_4pm_17", { 0.413901686668396, 0.6307775974273682, 0.6563573479652405 } },
        { "outdoor_4pm_18", { 0.46897420287132263, 0.6521645188331604, 0.5956045389175415 } },
        { "outdoor_4pm_19", { 0.5084130764007568, 0.700501561164856, 0.5008131265640259 } },
        { "outdoor_4pm_20", { 0.4447329044342041, 0.6575623750686646, 0.6081318259239197 } },
        { "outdoor_4pm_21", { 0.4841420352458954, 0.6652195453643799, 0.5684096217155457 } },
        { "outdoor_4pm_23", { 0.5032176375389099, 0.6989946365356445, 0.5081126689910889 } },
        { "outdoor_4pm_25", { 0.48785319924354553, 0.6803467869758606, 0.5469255447387695 } },
        { "outdoor_4pm_26", { 0.41278937458992004, 0.647605299949646, 0.6404781937599182 } },
        { "outdoor_4pm_27", { 0.5209073424339294, 0.7087074518203735, 0.4758038818836212 } },
        { "outdoor_4pm_28", { 0.48061898350715637, 0.6586491465568542, 0.5789530873298645 } },
        { "outdoor_4pm_29", { 0.5270968675613403, 0.7131839394569397, 0.4621012806892395 } },
        { "outdoor_4pm_30", { 0.467022567987442, 0.6545928120613098, 0.594473123550415 } },
        { "outdoor_4pm_31", { 0.5236248970031738, 0.7116202712059021, 0.46841609477996826 } },
        { "outdoor_4pm_32", { 0.5235860347747803, 0.7130712270736694, 0.4662478268146515 } },
        { "outdoor_4pm_33", { 0.5123212933540344, 0.691840648651123, 0.5088058710098267 } },
        { "outdoor_4pm_34", { 0.5112839937210083, 0.69834303855896, 0.50090491771698 } },
        { "outdoor_4pm_35", { 0.5130539536476135, 0.698253333568573, 0.49921730160713196 } },
        { "outdoor_4pm_36", { 0.522330105304718, 0.7066994905471802, 0.4772284924983978 } },
        { "outdoor_4pm_37", { 0.45456662774086, 0.652415931224823, 0.6064013242721558 } },
        { "outdoor_4pm_38", { 0.4283461272716522, 0.6539226770401001, 0.6236223578453064 } },
        { "outdoor_4pm_39", { 0.39195457100868225, 0.643168568611145, 0.6578037738800049 } },
        { "outdoor_4pm_40", { 0.4484527111053467, 0.6465648412704468, 0.6171256899833679 } },
        { "outdoor_4pm_41", { 0.4509553909301758, 0.6469562649726868, 0.6148877143859863 } },
        { "outdoor_4pm_42", { 0.44636794924736023, 0.6427807807922363, 0.6225661039352417 } },
        { "outdoor_4pm_43", { 0.4811229705810547, 0.635778546333313, 0.6035780310630798 } },
        { "outdoor_4pm_44", { 0.4539637863636017, 0.6418672204017639, 0.6179995536804199 } },
        { "outdoor_4pm_45", { 0.4774293899536133, 0.635831892490387, 0.6064478754997253 } },
        { "outdoor_4pm_46", { 0.4864446222782135, 0.671286940574646, 0.559236466884613 } },
        { "outdoor_4pm_47", { 0.4699550271034241, 0.6625580787658691, 0.5832315683364868 } },
        { "outdoor_4pm_48", { 0.4849524199962616, 0.6445512175559998, 0.5910793542861938 } },
        { "outdoor_4pm_51", { 0.4828689694404602, 0.6346677541732788, 0.6033526062965393 } },
        { "outdoor_4pm_52", { 0.4860880374908447, 0.6729949116706848, 0.5574910640716553 } },
        { "outdoor_4pm_53", { 0.4865127205848694, 0.6458341479301453, 0.5883907675743103 } },
        { "outdoor_4pm_54", { 0.4814320206642151, 0.6334851384162903, 0.6057391166687012 } },
        { "outdoor_4pm_55", { 0.48011988401412964, 0.63297039270401, 0.6073166131973267 } },
        { "outdoor_4pm_56", { 0.46559908986091614, 0.6510177850723267, 0.599494218826294 } },
        { "outdoor_4pm_57", { 0.4848385751247406, 0.6254881024360657, 0.61130690574646 } },
        { "outdoor_4pm_58", { 0.48229652643203735, 0.648360013961792, 0.5890833735466003 } },
        { "outdoor_4pm_59", { 0.4728351831436157, 0.6504737138748169, 0.5943995118141174 } },
        { "outdoor_4pm_60", { 0.4612918794155121, 0.6450982689857483, 0.6091453433036804 } },
        { "outdoor_4pm_61", { 0.40856167674064636, 0.6384311318397522, 0.6522905230522156 } },
        { "outdoor_4pm_62", { 0.4688010513782501, 0.6433427333831787, 0.6052567362785339 } },
        { "outdoor_4pm_63", { 0.5274719595909119, 0.7117574214935303, 0.46386921405792236 } },
        { "outdoor_4pm_64", { 0.49033424258232117, 0.6693772673606873, 0.5581276416778564 } },
        { "outdoor_4pm_65", { 0.5172500610351562, 0.7068412899971008, 0.4825221598148346 } },
        { "outdoor_4pm_66", { 0.5049658417701721, 0.6936758756637573, 0.513637363910675 } },
        { "outdoor_4pm_67", { 0.5045777559280396, 0.6938489675521851, 0.5137848258018494 } },
        { "outdoor_4pm_68", { 0.5150271654129028, 0.7077159285545349, 0.4836168587207794 } },
        { "outdoor_4pm_69", { 0.5183183550834656, 0.7013333439826965, 0.48936450481414795 } },
        { "outdoor_4pm_70", { 0.4990108907222748, 0.6908803582191467, 0.5231369733810425 } },
        { "outdoor_4pm_71", { 0.49689170718193054, 0.687160849571228, 0.5300082564353943 } },
        { "outdoor_4pm_72", { 0.5052927136421204, 0.6888010501861572, 0.5198386907577515 } },
        { "outdoor_4pm_73", { 0.49930229783058167, 0.6490033268928528, 0.5740138292312622 } },
        { "outdoor_4pm_74", { 0.49218159914016724, 0.6658903360366821, 0.5606669187545776 } },
        { "outdoor_4pm_75", { 0.47655537724494934, 0.6520956158638, 0.5896323323249817 } },
        { "outdoor_4pm_76", { 0.48370394110679626, 0.6525635123252869, 0.5832592844963074 } },
        { "outdoor_4pm_77", { 0.4947046935558319, 0.6606656908988953, 0.5646132826805115 } },
        { "outdoor_4pm_78", { 0.5231568217277527, 0.6983760595321655, 0.4884442985057831 } },
        { "outdoor_4pm_79", { 0.5234272480010986, 0.6946436166763306, 0.493451327085495 } },
        { "outdoor_4pm_80", { 0.4713660478591919, 0.6523119807243347, 0.5935512781143188 } },
        { "outdoor_4pm_81", { 0.4826752245426178, 0.6550750732421875, 0.5812927484512329 } },
        { "outdoor_4pm_82", { 0.4774916470050812, 0.6507409811019897, 0.5903710126876831 } },
        { "outdoor_4pm_83", { 0.47139281034469604, 0.6454443335533142, 0.6009912490844727 } },
        { "outdoor_4pm_84", { 0.4737096130847931, 0.6463971734046936, 0.5981386303901672 } },
        { "outdoor_4pm_85", { 0.49186837673187256, 0.6574454307556152, 0.5708160400390625 } },
        { "outdoor_4pm_86", { 0.4732211232185364, 0.6551080346107483, 0.588978111743927 } },
        { "outdoor_4pm_87", { 0.47491568326950073, 0.6537761092185974, 0.5890941023826599 } },
        { "outdoor_4pm_88", { 0.47503381967544556, 0.6576740741729736, 0.5846433043479919 } },
        { "outdoor_4pm_89", { 0.47831419110298157, 0.6611451506614685, 0.5780161619186401 } },
        { "outdoor_4pm_90", { 0.4874107539653778, 0.6615931391716003, 0.5698466897010803 } },
        { "outdoor_4pm_91", { 0.48126769065856934, 0.6626477241516113, 0.5738287568092346 } },
        { "outdoor_4pm_92", { 0.4597291350364685, 0.6578475832939148, 0.5965615510940552 } },
        { "outdoor_4pm_93", { 0.4819466769695282, 0.6591138243675232, 0.5773181915283203 } },
        { "outdoor_4pm_94", { 0.472089558839798, 0.6547196507453918, 0.5903165340423584 } },
        { "outdoor_4pm_95", { 0.4896967113018036, 0.6584604978561401, 0.5715126991271973 } },
        { "outdoor_4pm_96", { 0.47543108463287354, 0.6583739519119263, 0.5835315585136414 } },
        { "outdoor_4pm_97", { 0.4948079586029053, 0.6689239144325256, 0.5547124743461609 } },
        { "outdoor_4pm_98", { 0.4625171720981598, 0.6562498807907104, 0.5961660146713257 } },
        { "outdoor_4pm_99", { 0.4625563323497772, 0.6583617925643921, 0.5938024520874023 } },
        { "outdoor_4pm_100", { 0.4631430208683014, 0.6614720225334167, 0.5898756384849548 } },
        { "outdoor_4pm_101", { 0.459333598613739, 0.6619144082069397, 0.5923529863357544 } },
        { "outdoor_4pm_102", { 0.47742560505867004, 0.6645780801773071, 0.574804961681366 } },
        { "outdoor_4pm_103", { 0.45981907844543457, 0.658796489238739, 0.5954441428184509 } },
        { "outdoor_4pm_104", { 0.501607358455658, 0.6854467391967773, 0.527781069278717 } },
        { "outdoor_4pm_105", { 0.47515571117401123, 0.6603215336799622, 0.5815517902374268 } },
        { "outdoor_4pm_106", { 0.452115923166275, 0.6518886685371399, 0.6087958216667175 } },
        { "outdoor_4pm_107", { 0.45070692896842957, 0.6514003276824951, 0.6103612780570984 } },
        { "outdoor_4pm_108", { 0.47563132643699646, 0.6628981232643127, 0.5782222747802734 } },
        { "outdoor_4pm_109", { 0.4581475257873535, 0.6557095050811768, 0.6001214385032654 } },
        { "outdoor_4pm_110", { 0.46547630429267883, 0.6590538620948792, 0.5907451510429382 } },
        { "outdoor_4pm_111", { 0.4776238203048706, 0.6681447625160217, 0.5704893469810486 } },
        { "outdoor_4pm_112", { 0.4731091558933258, 0.6638427972793579, 0.5792067646980286 } },
        { "outdoor_4pm_113", { 0.4720431864261627, 0.6607390642166138, 0.5836088061332703 } },
        { "outdoor_4pm_114", { 0.4644469916820526, 0.6613726019859314, 0.588961124420166 } },
        { "outdoor_4pm_115", { 0.4628376364707947, 0.6737692356109619, 0.5760350227355957 } },
        { "outdoor_4pm_116", { 0.45810019969940186, 0.66233891248703, 0.5928332209587097 } },
        { "outdoor_4pm_117", { 0.43648579716682434, 0.6485018134117126, 0.6236390471458435 } },
        { "outdoor_4pm_118", { 0.45889702439308167, 0.6658437848091125, 0.5882734060287476 } },
        { "outdoor_4pm_119", { 0.467663049697876, 0.6660119295120239, 0.5811362266540527 } },
        { "outdoor_4pm_120", { 0.4742216169834137, 0.6632874608039856, 0.5789331793785095 } },
        { "outdoor_4pm_121", { 0.46539199352264404, 0.6591986417770386, 0.5906499624252319 } },
        { "outdoor_4pm_122", { 0.4633316397666931, 0.6611283421516418, 0.5901128649711609 } },
        { "outdoor_4pm_123", { 0.4648956060409546, 0.6618972420692444, 0.5880170464515686 } },
        { "outdoor_4pm_124", { 0.47375285625457764, 0.6495675444602966, 0.5946598052978516 } },
        { "outdoor_4pm_125", { 0.458735853433609, 0.6636925339698792, 0.5908246040344238 } },
        { "outdoor_4pm_126", { 0.4795481562614441, 0.6549264192581177, 0.584041953086853 } },
        { "outdoor_4pm_127", { 0.46200552582740784, 0.6507326364517212, 0.6025760769844055 } },
        { "outdoor_4pm_128", { 0.47087088227272034, 0.6620930433273315, 0.5830209255218506 } },
        { "outdoor_4pm_129", { 0.4904822111129761, 0.6659930348396301, 0.5620323419570923 } },
        { "outdoor_4pm_130", { 0.4914824366569519, 0.6698619723320007, 0.5565338134765625 } },
        { "outdoor_4pm_131", { 0.48793619871139526, 0.6516211628913879, 0.5807822942733765 } },
        { "outdoor_4pm_132", { 0.4805518388748169, 0.6539442539215088, 0.5843174457550049 } },
        { "outdoor_4pm_133", { 0.4889819324016571, 0.6574692726135254, 0.5732633471488953 } },
        { "outdoor_4pm_134", { 0.4915972948074341, 0.6510506868362427, 0.5783295631408691 } },
        { "outdoor_4pm_135", { 0.4984346628189087, 0.6598295569419861, 0.5623058676719666 } },
        { "outdoor_4pm_136", { 0.5154516696929932, 0.6829248666763306, 0.517612874507904 } },
        { "outdoor_4pm_137", { 0.5306658744812012, 0.7030360698699951, 0.473427951335907 } },
        { "outdoor_4pm_138", { 0.46372389793395996, 0.6496818661689758, 0.602389931678772 } },
        { "outdoor_4pm_139", { 0.4854068458080292, 0.663353443145752, 0.5695106983184814 } },
        { "outdoor_4pm_140", { 0.4935198128223419, 0.6672807335853577, 0.5578302145004272 } },
        { "outdoor_4pm_141", { 0.4735344350337982, 0.6531028151512146, 0.590950071811676 } },
        { "outdoor_4pm_142", { 0.5063378810882568, 0.6763061285018921, 0.5350065231323242 } },
        { "outdoor_4pm_143", { 0.4674172103404999, 0.6571484804153442, 0.5913349986076355 } },
        { "outdoor_4pm_144", { 0.48550522327423096, 0.6632135510444641, 0.5695896744728088 } },
        { "outdoor_4pm_146", { 0.5125247240066528, 0.690820574760437, 0.5099856853485107 } },
        { "outdoor_4pm_147", { 0.42910170555114746, 0.6613766551017761, 0.615185022354126 } },
        { "outdoor_4pm_148", { 0.44435155391693115, 0.662635862827301, 0.6028808951377869 } },
        { "outdoor_4pm_149", { 0.4709491729736328, 0.6592126488685608, 0.5862129330635071 } },
        { "outdoor_4pm_150", { 0.45598021149635315, 0.6530486941337585, 0.6046563386917114 } },
        { "outdoor_4pm_151", { 0.44381892681121826, 0.6612637042999268, 0.6047767996788025 } },
        { "outdoor_4pm_152", { 0.4445444345474243, 0.6644540429115295, 0.600733757019043 } },
        { "outdoor_4pm_159", { 0.49864643812179565, 0.6900302171707153, 0.5246045589447021 } },
        { "outdoor_4pm_160", { 0.4830019176006317, 0.6736745238304138, 0.5593493580818176 } },
        { "outdoor_4pm_163", { 0.4948142468929291, 0.6642467379570007, 0.5602991580963135 } },
        { "outdoor_4pm_164", { 0.4277830719947815, 0.6507692337036133, 0.627296507358551 } },
        { "outdoor_4pm_165", { 0.5066404938697815, 0.7306307554244995, 0.4577053487300873 } },
        { "outdoor_4pm_166", { 0.49344974756240845, 0.6801055073738098, 0.5421845316886902 } },
        { "outdoor_4pm_167", { 0.5103381276130676, 0.7102755308151245, 0.484833687543869 } },
        { "outdoor_4pm_168", { 0.5177573561668396, 0.7098336815834045, 0.477559894323349 } },
        { "outdoor_4pm_172", { 0.492279589176178, 0.7079514265060425, 0.5064243674278259 } },
        { "outdoor_noon_3", { 0.45643070340156555, 0.6592439413070679, 0.5975521206855774 } },
        { "outdoor_noon_4", { 0.45006316900253296, 0.654898464679718, 0.6070841550827026 } },
        { "outdoor_noon_6", { 0.501384437084198, 0.6842474937438965, 0.5295460820198059 } },
        { "outdoor_noon_7", { 0.4865679442882538, 0.6615460515022278, 0.5706210732460022 } },
        { "outdoor_noon_8", { 0.49333900213241577, 0.6596263647079468, 0.5670182108879089 } },
        { "outdoor_noon_9", { 0.4955950975418091, 0.660022497177124, 0.5645846724510193 } },
        { "outdoor_noon_10", { 0.49334365129470825, 0.6517924666404724, 0.576002299785614 } },
        { "outdoor_noon_11", { 0.4871780276298523, 0.6624400019645691, 0.5690614581108093 } },
        { "outdoor_noon_12", { 0.465850293636322, 0.6536950469017029, 0.5963775515556335 } },
        { "outdoor_noon_15", { 0.49739038944244385, 0.6643362641334534, 0.5579069256782532 } },
        { "outdoor_noon_16", { 0.49436765909194946, 0.6526966691017151, 0.5740972757339478 } },
        { "outdoor_noon_17", { 0.4869990944862366, 0.6646316051483154, 0.566653847694397 } },
        { "outdoor_noon_18", { 0.49609288573265076, 0.6691669225692749, 0.5532696843147278 } },
        { "outdoor_noon_19", { 0.4898015260696411, 0.6659781336784363, 0.5626433491706848 } },
        { "outdoor_noon_20", { 0.48932021856307983, 0.6712130904197693, 0.5568111538887024 } },
        { "outdoor_noon_21", { 0.4799592196941376, 0.6534432768821716, 0.5853641033172607 } },
        { "outdoor_noon_22", { 0.4983838200569153, 0.6662324666976929, 0.554750382900238 } },
        { "outdoor_noon_23", { 0.49914953112602234, 0.6610379815101624, 0.5602487325668335 } },
        { "outdoor_noon_24", { 0.5260999202728271, 0.6727407574653625, 0.5202295780181885 } },
        { "outdoor_noon_25", { 0.5172927975654602, 0.6597538590431213, 0.5450989603996277 } },
        { "outdoor_noon_26", { 0.48075345158576965, 0.6525554060935974, 0.585702657699585 } },
        { "outdoor_noon_27", { 0.46884748339653015, 0.6502578854560852, 0.5977849364280701 } },
        { "outdoor_noon_28", { 0.4764273762702942, 0.6543795466423035, 0.5872003436088562 } },
        { "outdoor_noon_29", { 0.48845842480659485, 0.6663273572921753, 0.5633969902992249 } },
        { "outdoor_noon_30", { 0.4747861623764038, 0.6584317088127136, 0.5839912295341492 } },
        { "outdoor_noon_31", { 0.49395322799682617, 0.6845070719718933, 0.536153256893158 } },
        { "outdoor_noon_32", { 0.4974648952484131, 0.6826552152633667, 0.5352668166160583 } },
        { "outdoor_noon_33", { 0.5225156545639038, 0.6816030144691467, 0.5122448205947876 } },
        { "outdoor_noon_34", { 0.5128621459007263, 0.670953094959259, 0.535531759262085 } },
        { "outdoor_noon_35", { 0.4674874544143677, 0.6486984491348267, 0.600537896156311 } },
        { "outdoor_noon_36", { 0.48418837785720825, 0.658693253993988, 0.5759208798408508 } },
        { "outdoor_noon_37", { 0.5083273649215698, 0.6571022272109985, 0.5566147565841675 } },
        { "outdoor_noon_38", { 0.5130241513252258, 0.6647188067436218, 0.543097734451294 } },
        { "outdoor_noon_39", { 0.5067110657691956, 0.6580867767333984, 0.5569251179695129 } },
        { "outdoor_noon_40", { 0.5034244656562805, 0.6631045341491699, 0.5539460182189941 } },
        { "outdoor_noon_41", { 0.4662049114704132, 0.6468470096588135, 0.6035246253013611 } },
        { "outdoor_noon_42", { 0.4672200679779053, 0.6503205299377441, 0.598989725112915 } },
        { "outdoor_noon_43", { 0.5152620673179626, 0.6596870422363281, 0.5470996499061584 } },
        { "outdoor_noon_44", { 0.5103988647460938, 0.6728681325912476, 0.5354824066162109 } },
        { "outdoor_noon_45", { 0.5095715522766113, 0.6884963512420654, 0.5160520076751709 } },
        { "outdoor_noon_46", { 0.5079287886619568, 0.6725677251815796, 0.5382016897201538 } },
        { "outdoor_noon_47", { 0.5372726917266846, 0.6963269710540771, 0.47588545083999634 } },
        { "outdoor_noon_48", { 0.5298998951911926, 0.6890047788619995, 0.49444764852523804 } },
        { "outdoor_noon_49", { 0.4831215739250183, 0.6605478525161743, 0.5746912360191345 } },
        { "outdoor_noon_50", { 0.4862525165081024, 0.6630381941795349, 0.5691562294960022 } },
        { "outdoor_noon_51", { 0.4874119162559509, 0.6534129977226257, 0.5792072415351868 } },
        { "outdoor_noon_52", { 0.4718833863735199, 0.6583499312400818, 0.5864311456680298 } },
        { "outdoor_noon_53", { 0.47639933228492737, 0.6631966233253479, 0.5772468447685242 } },
        { "outdoor_noon_54", { 0.47999176383018494, 0.6664913892745972, 0.5704359412193298 } },
        { "outdoor_noon_55", { 0.49995970726013184, 0.6714129447937012, 0.5470328330993652 } },
        { "outdoor_noon_56", { 0.4166955351829529, 0.6422722339630127, 0.6433127522468567 } },
        { "outdoor_noon_57", { 0.521539568901062, 0.6902576088905334, 0.5015385746955872 } },
        { "outdoor_noon_58", { 0.5525532364845276, 0.7068419456481934, 0.4416552484035492 } },
        { "outdoor_noon_59", { 0.4898616075515747, 0.6550168991088867, 0.5753159523010254 } },
        { "outdoor_noon_60", { 0.469131737947464, 0.6454561352729797, 0.6027451753616333 } },
        { "outdoor_noon_61", { 0.466419517993927, 0.6416868567466736, 0.6088438034057617 } },
        { "outdoor_noon_62", { 0.4737682640552521, 0.6450802683830261, 0.5995123982429504 } },
        { "outdoor_noon_63", { 0.4730033278465271, 0.6462168097496033, 0.598892092704773 } },
        { "outdoor_noon_64", { 0.4674621820449829, 0.6448051929473877, 0.6047357320785522 } },
        { "outdoor_noon_65", { 0.4953567087650299, 0.654904305934906, 0.5707206130027771 } },
        { "outdoor_noon_66", { 0.45114225149154663, 0.6607513427734375, 0.5998985767364502 } },
        { "outdoor_noon_67", { 0.4581500291824341, 0.6529526710510254, 0.6031180620193481 } },
        { "outdoor_noon_68", { 0.5171623826026917, 0.6762080192565918, 0.5246767997741699 } },
        { "outdoor_noon_69", { 0.5223581194877625, 0.6814153790473938, 0.5126549601554871 } },
        { "outdoor_noon_70", { 0.4243241548538208, 0.6455162763595581, 0.6350257992744446 } },
        { "outdoor_noon_71", { 0.41645190119743347, 0.6408056020736694, 0.6449309587478638 } },
        { "outdoor_noon_72", { 0.483381450176239, 0.6575111150741577, 0.5779459476470947 } },
        { "outdoor_noon_73", { 0.48588675260543823, 0.6624658703804016, 0.5701342225074768 } },
        { "outdoor_noon_74", { 0.48321351408958435, 0.6620786190032959, 0.5728495121002197 } },
        { "outdoor_noon_75", { 0.5035341382026672, 0.673174262046814, 0.5415624380111694 } },
        { "outdoor_noon_76", { 0.5187640190124512, 0.6860105991363525, 0.5101699233055115 } },
        { "outdoor_noon_77", { 0.4986553490161896, 0.6752523183822632, 0.5434861183166504 } },
        { "outdoor_noon_78", { 0.4780604839324951, 0.670521080493927, 0.5673269033432007 } },
        { "outdoor_noon_79", { 0.47259387373924255, 0.6735921502113342, 0.5682680606842041 } },
        { "outdoor_noon_80", { 0.4832631051540375, 0.6671001315116882, 0.5669516324996948 } },
        { "outdoor_noon_81", { 0.4955456554889679, 0.653823971748352, 0.571794331073761 } },
        { "outdoor_noon_82", { 0.4667898714542389, 0.6518731117248535, 0.5976359248161316 } },
        { "outdoor_noon_83", { 0.47543999552726746, 0.6431121230125427, 0.6003029346466064 } },
        { "outdoor_noon_84", { 0.4936397969722748, 0.655707597732544, 0.5712856650352478 } },
        { "outdoor_noon_85", { 0.49932610988616943, 0.6598176956176758, 0.5615283250808716 } },
        { "outdoor_noon_86", { 0.49583953619003296, 0.6617322564125061, 0.5623641610145569 } },
        { "outdoor_noon_87", { 0.4983743727207184, 0.6612770557403564, 0.5606565475463867 } },
        { "outdoor_noon_88", { 0.5008986592292786, 0.6623388528823853, 0.5571425557136536 } },
        { "outdoor_noon_89", { 0.48668989539146423, 0.6610181331634521, 0.5711287260055542 } },
        { "outdoor_noon_90", { 0.4921886622905731, 0.6588855385780334, 0.5688761472702026 } },
        { "outdoor_noon_91", { 0.498064786195755, 0.6688423752784729, 0.5518889427185059 } },
        { "outdoor_noon_92", { 0.4925609529018402, 0.6628516316413879, 0.5639249682426453 } },
        { "outdoor_noon_93", { 0.4872240722179413, 0.6642082333564758, 0.5669568777084351 } },
        { "outdoor_noon_94", { 0.5007877945899963, 0.6734615564346313, 0.5437473058700562 } },
        { "outdoor_noon_95", { 0.4763859808444977, 0.6596639752388, 0.5812916159629822 } },
        { "outdoor_noon_96", { 0.47449347376823425, 0.6560240387916565, 0.5869312882423401 } },
        { "outdoor_noon_97", { 0.48756521940231323, 0.6664968132972717, 0.5639699697494507 } },
        { "outdoor_noon_98", { 0.45913469791412354, 0.6464431285858154, 0.6093493103981018 } },
        { "outdoor_noon_99", { 0.48883020877838135, 0.67027747631073, 0.5583664178848267 } },
        { "outdoor_noon_100", { 0.47523656487464905, 0.6604694724082947, 0.5813177824020386 } },
        { "outdoor_noon_101", { 0.5114054679870605, 0.6758391261100769, 0.5307598114013672 } },
        { "outdoor_noon_102", { 0.4873625338077545, 0.6724729537963867, 0.5570080280303955 } },
        { "outdoor_noon_103", { 0.4973578453063965, 0.6700295209884644, 0.5510858297348022 } },
        { "outdoor_noon_104", { 0.5263456106185913, 0.6767289042472839, 0.5147798657417297 } },
        { "outdoor_noon_105", { 0.5098649859428406, 0.6665772795677185, 0.5437944531440735 } },
        { "outdoor_noon_106", { 0.47284626960754395, 0.6580591797828674, 0.5859817266464233 } },
        { "outdoor_noon_107", { 0.5237933397293091, 0.6609492897987366, 0.5373886227607727 } },
        { "outdoor_noon_108", { 0.4873200058937073, 0.6508729457855225, 0.5821371674537659 } },
        { "outdoor_noon_109", { 0.5000054240226746, 0.6516537666320801, 0.5703876614570618 } },
        { "outdoor_noon_110", { 0.47002077102661133, 0.647346556186676, 0.6000190377235413 } },
        { "outdoor_noon_111", { 0.4918702244758606, 0.6676183342933655, 0.5588823556900024 } },
        { "outdoor_noon_112", { 0.5340489745140076, 0.6957452893257141, 0.480343759059906 } },
        { "outdoor_noon_113", { 0.5025541186332703, 0.6627691984176636, 0.5551363229751587 } },
        { "outdoor_noon_114", { 0.49167782068252563, 0.6697058081626892, 0.5565492510795593 } },
        { "outdoor_noon_115", { 0.49572065472602844, 0.669840395450592, 0.5527883172035217 } },
        { "outdoor_noon_116", { 0.5320944786071777, 0.691209614276886, 0.4889833331108093 } },
        { "outdoor_noon_117", { 0.49275389313697815, 0.6690699458122253, 0.5563622713088989 } },
        { "outdoor_noon_118", { 0.4849418103694916, 0.672157883644104, 0.5594955086708069 } },
        { "outdoor_noon_119", { 0.48819416761398315, 0.672330379486084, 0.5564514398574829 } },
        { "outdoor_noon_120", { 0.5220599174499512, 0.6946313381195068, 0.49491485953330994 } },
        { "outdoor_noon_121", { 0.4766027629375458, 0.6520899534225464, 0.5896002650260925 } },
        { "outdoor_noon_122", { 0.46893033385276794, 0.6538205146789551, 0.5938206911087036 } },
        { "outdoor_noon_129", { 0.4576930105686188, 0.6495915055274963, 0.6070814728736877 } },
        { "outdoor_noon_130", { 0.49648967385292053, 0.6786057353019714, 0.5412875413894653 } },
        { "outdoor_noon_131", { 0.46546223759651184, 0.6584966778755188, 0.591377317905426 } },
        { "outdoor_noon_132", { 0.4678235948085785, 0.652565062046051, 0.5960704684257507 } },
        { "outdoor_noon_133", { 0.4495750963687897, 0.6506338715553284, 0.6120113134384155 } },
        { "outdoor_noon_134", { 0.5093608498573303, 0.6562057137489319, 0.5567276477813721 } },
        { "outdoor_noon_135", { 0.5084904432296753, 0.6545592546463013, 0.5594547986984253 } },
        { "outdoor_noon_136", { 0.519402265548706, 0.6586899161338806, 0.5443792343139648 } },
        { "outdoor_noon_137", { 0.5053291320800781, 0.6618207693099976, 0.5537469387054443 } },
        { "outdoor_noon_138", { 0.48365673422813416, 0.6619983315467834, 0.5725682377815247 } },
        { "outdoor_noon_139", { 0.472391813993454, 0.6470740437507629, 0.5984489917755127 } },
        { "outdoor_noon_140", { 0.4894102215766907, 0.6591678857803345, 0.5709425210952759 } },
        { "outdoor_noon_142", { 0.5004374384880066, 0.6663152575492859, 0.5527985095977783 } },
        { "outdoor_noon_145", { 0.48285022377967834, 0.6583579182624817, 0.5774257183074951 } },
        { "outdoor_noon_146", { 0.4898195266723633, 0.6610602736473083, 0.5683979392051697 } },
        { "outdoor_noon_148", { 0.49092918634414673, 0.7004778981208801, 0.5179954171180725 } },
        { "outdoor_noon_150", { 0.4956243336200714, 0.6411755681037903, 0.5858756303787231 } },
        { "outdoor_noon_151", { 0.4807540774345398, 0.6750920414924622, 0.5595768690109253 } },
        { "outdoor_noon_152", { 0.4946072995662689, 0.7044562697410583, 0.5090237259864807 } },
        { "outdoor_noon_153", { 0.5076180696487427, 0.7049222588539124, 0.49538710713386536 } },
        { "outdoor_noon_155", { 0.493029922246933, 0.6866251230239868, 0.5342915058135986 } },
        { "outdoor_noon_156", { 0.4791259765625, 0.6663715243339539, 0.5713032484054565 } },
        { "outdoor_noon_157", { 0.4945530891418457, 0.6941529512405396, 0.5230379700660706 } },
        { "outdoor_noon_158", { 0.470857709646225, 0.6668038964271545, 0.5776379704475403 } },
        { "outdoor_noon_161", { 0.47634169459342957, 0.6791292428970337, 0.558463990688324 } },
        { "outdoor_noon_162", { 0.4761689603328705, 0.6733832955360413, 0.5655245780944824 } },
        { "outdoor_noon_164", { 0.485857754945755, 0.6905487179756165, 0.5358028411865234 } },
        { "outdoor_noon_165", { 0.4837110638618469, 0.6625109910964966, 0.5719290971755981 } },
        { "outdoor_noon_166", { 0.4816446602344513, 0.6878587007522583, 0.5430182218551636 } },
        { "outdoor_noon_167", { 0.496794193983078, 0.6938498020172119, 0.5213137865066528 } },
        { "outdoor_noon_177", { 0.543221652507782, 0.7395766377449036, 0.3974124789237976 } },
        { "outdoor_noon_182", { 0.5275070667266846, 0.7174973487854004, 0.45489978790283203 } },
        { "outdoor_noon_187", { 0.4900496006011963, 0.6595469117164612, 0.5699554085731506 } },
        { "outdoor_noon_188", { 0.501067042350769, 0.6967813372612, 0.5132519006729126 } },
        { "outdoor_noon_189", { 0.4890110492706299, 0.6716848015785217, 0.5565140247344971 } },
    };
    
    const Mat<double,3,3> C5IllumCorrectionMatrix(
        1.25407726323103,       0., -0.245441000321451,
        0.,                     1., 0.,
        -0.0687922873207393,    0., 0.868851550191642
    );
    
//    const Color<ColorSpace::Raw>& illumRaw = C50Illuminants.at(path.filename().replace_extension());
//    const Color<ColorSpace::Raw>& illum(C5IllumCorrectionMatrix*illumRaw.m);
    const size_t len = sizeof(uint16_t)*width*height;
    const Mmap imgMmap(path.c_str());
    
    // Verify that the file size is what we expect, given the image width/height
    if (imgMmap.len() != len) throw std::runtime_error("invalid length");
    
    // Create a Metal buffer, and copy the image contents into it
    Renderer::Buf imgBuf = renderer.createBuffer(len);
    memcpy([imgBuf contents], imgMmap.data(), len);
    
    Renderer::Txt raw = renderer.createTexture(MTLPixelFormatR32Float, width, height);
    
    // Load `raw`
    renderer.render("CFAViewer::Shader::ImagePipeline::LoadRaw", raw,
        // Buffer args
        CFADesc,
        width,
        height,
        imgBuf
        // Texture args
    );
    
//    // Reconstruct highlights
//    {
//        const simd::float3 badPixelFactors = {1.130, 1.613, 1.000};
//        const simd::float3 goodPixelFactors = {1.051, 1.544, 1.195};
//        Renderer::Txt tmp = renderer.createTexture(MTLPixelFormatR32Float, width, height);
//        renderer.render("CFAViewer::Shader::ImagePipeline::ReconstructHighlights", tmp,
//            // Buffer args
//            CFADesc,
//            badPixelFactors,
//            goodPixelFactors,
//            // Texture args
//            raw
//        );
//        raw = std::move(tmp);
//    }
//    
//    // White balance
//    {
//        const simd::float3 whiteBalance = {
//            (float)(illum[1]/illum[0]),
//            (float)(illum[1]/illum[1]),
//            (float)(illum[1]/illum[2])
//        };
//        renderer.render("CFAViewer::Shader::ImagePipeline::WhiteBalance", raw,
//            // Buffer args
//            CFADesc,
//            whiteBalance,
//            // Texture args
//            raw
//        );
//    }
    
    // LMMSE Debayer
    Renderer::Txt rgb = renderer.createTexture(MTLPixelFormatRGBA32Float, width, height);
    {
        DebayerLMMSE::Run(renderer, CFADesc, false, raw, rgb);
    }
    
//    // Camera raw -> ProPhotoRGB
//    {
//        const CCM ccm = CCMForIlluminant(illum);
//        const simd::float3x3 ccmSIMD = SIMDFromMat(ccm.m);
//        renderer.render("CFAViewer::Shader::ImagePipeline::ApplyColorMatrix", rgb,
//            // Buffer args
//            ccmSIMD,
//            // Texture args
//            rgb
//        );
//    }
//    
//    // ProPhotoRGB -> XYZ.D50
//    {
//        renderer.render("CFAViewer::Shader::ImagePipeline::XYZD50FromProPhotoRGB", rgb,
//            // Texture args
//            rgb
//        );
//    }
//    
//    // XYZ.D50 -> XYZ.D65
//    {
//        renderer.render("CFAViewer::Shader::ImagePipeline::BradfordXYZD65FromXYZD50", rgb,
//            // Texture args
//            rgb
//        );
//    }
//    
//    // XYZ.D65 -> LSRGB.D65
//    {
//        renderer.render("CFAViewer::Shader::ImagePipeline::LSRGBD65FromXYZD65", rgb,
//            // Texture args
//            rgb
//        );
//    }
//    
//    // Apply SRGB gamma
//    {
//        renderer.render("CFAViewer::Shader::ImagePipeline::SRGBGamma", rgb,
//            // Texture args
//            rgb
//        );
//    }
    
    // Final display render pass
    Renderer::Txt rgba16 = renderer.createTexture(MTLPixelFormatRGBA16Float,
        width, height, MTLTextureUsageRenderTarget|MTLTextureUsageShaderRead);
    renderer.render("CFAViewer::Shader::ImagePipeline::Display", rgba16,
        // Texture args
        rgb
    );
    
    renderer.sync(rgba16);
    renderer.commitAndWait();
    
    const fs::path pngPath = fs::path(path).replace_extension(".png");
    std::cout << pngPath << "\n";
    writePNG(rgba16, pngPath);
}

static bool isCFAFile(const fs::path& path) {
    return fs::is_regular_file(path) && path.extension() == ".cfa";
}

int main(int argc, const char* argv[]) {
//    printf("D55 CCT: %.1f K\n", CCTFromXYChromaticity(0.332424, 0.347426));
//    exit(0);
    
    const uint32_t Width = 2304;
    const uint32_t Height = 1296;
    
    Renderer renderer;
    {
        id<MTLDevice> dev = MTLCreateSystemDefaultDevice();
        assert(dev);
        
        auto metalLibPath = fs::path(argv[0]).replace_filename("default.metallib");
        id<MTLLibrary> lib = [dev newLibraryWithFile:@(metalLibPath.c_str()) error:nil];
        assert(lib);
        id<MTLCommandQueue> commandQueue = [dev newCommandQueue];
        assert(commandQueue);
        
        renderer = Renderer(dev, lib, commandQueue);
    }
    
    for (int i=1; i<argc; i++) {
        const char* pathArg = argv[i];
        
        // Regular file
        if (isCFAFile(pathArg)) {
            createPNGFromCFA(renderer, Width, Height, pathArg);
        
        // Directory
        } else if (fs::is_directory(pathArg)) {
            for (const auto& f : fs::directory_iterator(pathArg)) {
                if (isCFAFile(f)) {
                    createPNGFromCFA(renderer, Width, Height, f);
                }
            }
        }
    }
    
    return 0;
}
